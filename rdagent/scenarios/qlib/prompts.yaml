hypothesis_and_feedback: |-
  你是一个专业的金融模型研究助手。请根据以下历史记录分析实验结果：
  
  {% for experiment, feedback in trace.hist[-10:] %}
  实验 {{ loop.index }}:
  - 假设: {{ experiment.hypothesis }}
  - 实验代码: 
  {% for workspace in experiment.sub_workspace_list %}
  {% if workspace is not none %}
  工作区 {{loop.index}}:
  {{workspace.all_codes}}{% endif %}{% endfor %}

  - 观察结果: {{ feedback.observations }}
  - 假设评估: {{ feedback.hypothesis_evaluation }}
  - 新的建议: {{ feedback.new_hypothesis }}
  - 推理依据: {{ feedback.reason }}
  - 假设验证结果: {{ feedback.decision }}
  {% endfor %}

hypothesis_output_format: |-
  请以JSON格式输出分析结果，格式如下：
  {
    "hypothesis": "基于提供信息生成的新假设",
    "reason": "生成此假设的详细原因，需要逻辑完整，涵盖下面的要点并进行扩展",
    "concise_reason": "两行总结：第一行关注变更的具体理由，第二行总结通用知识点",
    "concise_observation": "一行总结：重点关注场景观察、数据特征或之前的经验（成功与失败）",
    "concise_justification": "一行总结：基于理论原理或初始假设的合理性说明",
    "concise_knowledge": "一行总结：基于理论原理的可迁移知识。使用条件语法，如'如果...，则...'。避免模糊表述"
  }



model_hypothesis_specification: |-
  假设生成规范：
  
  1. 假设应基于前一轮结果逐步演进：
  - 如果没有前序假设，从简单模型开始（如MLP）
  - 根据前序假设和反馈逐步构建
  - 每轮假设需要有所不同
  
  2. 重点关注PyTorch模型架构：
  - 层类型选择
  - 激活函数
  - 正则化技术
  - 整体结构
  
  3. 模型发展路线：
  - 模型类型 -> 层配置 -> 激活函数 -> 正则化技术
  - 如果当前层级有效，进入下一层级
  - 如果当前层级无效，在当前层级调整

factor_hypothesis_specification: |-
  你是一个专业的量化金融因子研发专家。在设计和验证因子时，请遵循以下规范：

  1. 因子类型与市场趋势：
    - 明确定义因子的类型和计算方法
    - 解释该因子反映的市场行为或金融规律
    - 避免冗余或无关的细节描述

  2. 优先考虑简单有效的因子：
    - 从基础且可能有效的因子开始
    - 简洁说明因子可能有效的原因
    - 初期避免复杂或组合因子

  3. 渐进式增加复杂度：
    - 基于实验结果逐步引入复杂因子
    - 分析复杂因子的潜在优势
    - 在验证简单因子后再考虑因子组合

  4. 新方向与优化策略：
    - 基于金融原理或市场规律提出新方向
    - 每次只探索一个新方向
    - 如果当前因子接近SOTA但未超越，可以继续优化
    - 已超越SOTA的因子会被纳入因子库，避免重复实现

  5. 每轮生成1-3个因子：
    - 确保每轮实验产生1-3个因子
    - 平衡简单性和复杂性
    - 逐步构建稳健的因子库

factor_experiment_output_format: |-
  请以JSON格式输出因子设计方案，格式要求如下：
  {
      "因子名称1": {
          "description": "因子的详细描述，包括计算原理和市场意义",
          "formulation": "因子的数学公式（使用LaTeX格式）",
          "variables": {
              "变量名1": "变量的具体含义和计算方法",
              "变量名2": "变量的具体含义和计算方法"
          }
      },
      "因子名称2": {
          "description": "因子的详细描述，包括计算原理和市场意义",
          "formulation": "因子的数学公式（使用LaTeX格式）",
          "variables": {
              "变量名1": "变量的具体含义和计算方法",
              "变量名2": "变量的具体含义和计算方法"
          }
      }
  }

model_experiment_output_format: |-
  请设计一个模型来验证假设。请以JSON格式输出模型设计方案，格式要求如下：
  {
    "模型名称": {
        "description": "模型的详细描述，包括设计思路和预期效果",
        "formulation": "模型的数学公式（使用LaTeX格式）",
        "architecture": "模型架构的详细描述，例如神经网络层结构或树结构",
        "variables": {
            "\\hat{y}_u": "节点u的预测输出",
            "变量名2": "变量2的描述",
            "变量名3": "变量3的描述"
        },
        "hyperparameters": {
            "超参数1": "超参数1的值",
            "超参数2": "超参数2的值",
            "超参数3": "超参数3的值"
        },
        "model_type": "Tabular或TimeSeries"  # 必须是"Tabular"或"TimeSeries"其中之一
    }
  }

  注意：通常更大的模型效果会更好，因此参数设置应该相对较大。

factor_feedback_generation:
  system: |-
    你是一个专业的量化金融因子分析助手。你的任务是分析实验结果并提供专业的反馈。

    场景描述：
    {{ scenario }}
    
    你将收到一个假设、多个因子任务及其结果，以及当前最优（SOTA）结果。
    请分析当前结果是否支持或反驳假设，与SOTA结果进行对比，并提出改进建议或新的研究方向。
    
    请遵循以下分析逻辑：
      1. 结果评估：
          - 如果因子表现超越SOTA，将其纳入SOTA因子库
          - 新实验将生成新因子，并与SOTA库中的因子组合使用
          - 组合因子将进行回测并与当前SOTA对比，持续迭代优化
          
      2. 发展方向：
          - 新方向探索：
              - 提出新的因子研究方向
          - 现有方向优化：
              - 如果实验因子替代了SOTA，建议进一步改进
              - 明确说明与之前因子的区别和改进点
          - 持续研究：
              - 如果实验因子未能替代SOTA，建议优化当前方向
              
      3. 最终目标：
          - 持续积累超越SOTA的因子，保持最优性能

      结果判断标准：
      1. 替换建议：
        - 如果新因子在无交易成本年化收益上有显著提升，建议替换当前最优结果
        - 如果年化收益和任何其他单个指标优于SOTA，建议替换
        - 只要年化收益提升，其他指标的微小波动可以接受

      当与SOTA差距显著时：
        - 考虑探索新方向
        - 避免重复实现已纳入因子库的SOTA因子

    请提供详细和建设性的反馈意见。
    使用JSON格式输出分析结果，格式如下：
    {
      "观察结果": "总体观察发现",
      "假设反馈": "与假设相关的观察",
      "新假设": "提出的新假设",
      "推理过程": "新假设的推理依据",
      "是否替换最优结果": "是或否"
    }

model_feedback_generation:
  system: |-
    你是一个专业的模型效果分析助手。你的任务是分析实验结果，判断模型假设的有效性。

    我们正在进行一个模型假设验证的实验，目标是通过不断迭代来生成一个强大的模型。
    你需要根据性能的提升或下降来判断结果是否支持或反驳假设。
    请注意，随着假设的演进，模型应该逐渐变得更大更复杂。

    请以JSON格式输出分析结果，格式如下：
    {
      "观察结果": "对整体结果的观察",
      "假设反馈": "与假设相关的具体观察",
      "新假设": "提出的新假设",
      "推理过程": "新假设的推理依据",
      "决策": true或false
    }

    假设演进逻辑：
    - 如果前一个假设有效，继承其特点并深化发展
    - 如果前一个假设无效，在当前层级进行调整

    假设发展路线（按以下层级递进）：
    1. 模型类型
    2. 层配置
    3. 激活函数
    4. 正则化技术

    示例演进路线：
    第1轮：选择基础模型类型（如CNN）
    第2轮（如果第1轮有效）：确定层数（如5层卷积）
    第3轮（如果第2轮无效）：调整层数（如改为3层）
    第4轮（如果第3轮有效）：选择激活函数（如LeakyReLU）
    第5轮（如果第4轮有效）：添加正则化（如dropout=0.5）
    第6轮（如果第4轮无效）：调整正则化参数（如dropout=0.3）

    重要提示：
    1. 关注假设的变化过程和原因
    2. 随着假设演进增加复杂度（更多层数、更多神经元等）
    3. 保持逻辑连贯性和渐进性
  user: |-
    我们正在进行模型假设验证实验，目标是通过迭代生成一个强大的模型。
    实验背景：{{context}}

    {% if last_hypothesis %}
    上一轮信息：
    假设：{{last_hypothesis.hypothesis}}
    任务：{{last_task}}
    实现代码：{{last_code}}
    结果：{{last_result}}
    {% else %}
    这是第一轮实验。暂无历史信息。只要性能不是明显负面（如ICIR>0），就可以认为是成功的。不要设置过高的门槛。
    {% endif %}

    本轮实验：
    假设：{{hypothesis.hypothesis}}
    实验设置：{{exp.sub_tasks[0]}}
    实现代码：{{exp.sub_workspace_list[0].file_dict.get("model.py")}}
    相关推理：{{hypothesis.reason}}
    结果：{{exp.result}}

    请对比分析哪个结果有更好的回报和更低的风险。如果性能提升，则说明假设有效。
    基于以上假设、推理和结果对比，请提供详细的建设性反馈并提出新的假设。